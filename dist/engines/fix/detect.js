"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.detectFixes = detectFixes;
exports.formatFixReport = formatFixReport;
const pathfinder_1 = require("../topology/pathfinder");
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
function detectFixes(snapshot, workspaceRoot) {
    const fixes = [];
    // 1. Missing routes (orphan modules with no entry path)
    const orphans = snapshot.modules.filter((m) => {
        const pathResult = (0, pathfinder_1.findPathTo)(m.id, snapshot.modules, snapshot.edges);
        return !pathResult || pathResult.nodes.length === 0;
    });
    orphans.forEach((orphan) => {
        fixes.push({
            type: "missing_route",
            severity: "high",
            target: orphan.name,
            description: `Module ${orphan.name} has no route from entry point`,
            suggestedPath: ["cli/cwy.ts", orphan.name],
            action: "create_stub",
            skeleton: generateRouteStub(orphan),
        });
    });
    // 2. Unused files (modules with no incoming or outgoing edges)
    const unused = snapshot.modules.filter((m) => {
        const hasIncoming = snapshot.edges.some((e) => e.to === m.id);
        const hasOutgoing = snapshot.edges.some((e) => e.from === m.id);
        return !hasIncoming && !hasOutgoing;
    });
    unused.forEach((u) => {
        fixes.push({
            type: "unused_file",
            severity: "medium",
            target: u.path,
            description: `File ${u.path} is not imported or used anywhere`,
            action: "review",
        });
    });
    // 3. Missing docs (README.md, OpenAPI, etc.)
    const readmePath = path_1.default.join(workspaceRoot, "README.md");
    if (!fs_1.default.existsSync(readmePath)) {
        fixes.push({
            type: "missing_doc",
            severity: "low",
            target: "README.md",
            description: "Project documentation missing",
            action: "create_doc",
            skeleton: generateReadmeSkeleton(snapshot),
        });
    }
    // 4. Broken imports (imports that couldn't be resolved - detected during scan)
    // This would be populated by topology scanner tracking failed resolves
    // For now, we'll leave this as a placeholder for enhancement
    // Calculate summary
    const summary = {
        total: fixes.length,
        high: fixes.filter((f) => f.severity === "high").length,
        medium: fixes.filter((f) => f.severity === "medium").length,
        low: fixes.filter((f) => f.severity === "low").length,
    };
    return { fixes, summary };
}
function generateRouteStub(module) {
    const moduleName = module.name.split("/").pop() || "module";
    const varName = moduleName.replace(/[^a-zA-Z0-9]/g, "");
    return `// Auto-generated by CWY (stub only - implement logic)
import * as ${varName} from "../${module.path.replace(/\.ts$/, "")}";

export function register${varName.charAt(0).toUpperCase() + varName.slice(1)}() {
  // TODO: Connect ${module.name} to your application
  // This stub ensures the module is reachable in the graph
  console.log("${module.name} registered");
}
`;
}
function generateReadmeSkeleton(snapshot) {
    const moduleCount = snapshot.modules.length;
    const edgeCount = snapshot.edges.length;
    return `# Project Overview

> Generated by CWY - offline-first system mapping

## Structure

- **Modules**: ${moduleCount}
- **Connections**: ${edgeCount}

## Architecture

\`\`\`
[Generated graph visualization would go here]
\`\`\`

## Getting Started

\`\`\`bash
# Install dependencies
npm install

# Run the application
npm start
\`\`\`

## Documentation

- See \`cwy overview\` for system snapshot
- See \`cwy integrity\` for health checks
- See \`cwy route <target>\` for path tracing

---

*This README was generated by CWY. Update it with your project-specific details.*
`;
}
function formatFixReport(report) {
    const lines = [
        "FIX REPORT\n",
        `Total fixes: ${report.summary.total} (${report.summary.high} high, ${report.summary.medium} medium, ${report.summary.low} low)\n`,
    ];
    if (report.summary.high > 0) {
        lines.push("High priority:");
        report.fixes
            .filter((f) => f.severity === "high")
            .forEach((f) => {
            lines.push(`  \u2717 ${f.description}`);
            if (f.suggestedPath) {
                lines.push(`     Suggested route: ${f.suggestedPath.join(" â†’ ")}`);
            }
            lines.push(`     Action: ${f.action}\n`);
        });
    }
    if (report.summary.medium > 0) {
        lines.push("Medium priority:");
        report.fixes
            .filter((f) => f.severity === "medium")
            .forEach((f) => {
            lines.push(`  \u26A0  ${f.description}`);
            lines.push(`     Action: ${f.action}\n`);
        });
    }
    if (report.summary.low > 0) {
        lines.push("Low priority:");
        report.fixes
            .filter((f) => f.severity === "low")
            .forEach((f) => {
            lines.push(`  \u2139  ${f.description}`);
            lines.push(`     Action: ${f.action}\n`);
        });
    }
    if (report.summary.total === 0) {
        lines.push("\u2713 No fixes needed - system is healthy!");
    }
    else {
        lines.push("\nTo apply fixes (creates skeleton files only):");
        lines.push("  cwy fix --apply");
    }
    return lines.join("\n");
}
//# sourceMappingURL=detect.js.map